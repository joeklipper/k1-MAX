# K1 MAX
# Printer_size: 300x300x300
# Version: v1.0.2
# CreateDate: 2023/03/21
# Nozzle_mcu: chip: GD32F303CBT6
#             version: CR-K1-MAX-NOZZLE-V1.0.0
# Leveling_mcu: chip: GD32E230F8P6
#             version: CR-K1-MAX-LEVELING-V1.0.0
# mcu: chip: GD32F303RET6
#      version: CR4CU220812S12

#===INCLUDES===

[include fluidd.cfg]
[include KNOMI.cfg]
[include sensorless.cfg]
[include gcode_macro.cfg]
[include timelapse.cfg]
[include cartographer_macro.cfg]
[include KAMP_Settings.cfg]
[exclude_object]
[include K-ShakeTune/*.cfg]
# [include aux_fan.cfg]
[include shell_command.cfg]

#===MCUs===

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1F00270009504B5735313920-if00

[mcu nozzle_mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0  
baud: 230400
restart_method: command

[mcu CB2]
serial: /tmp/klipper_host_mcu

[temperature_sensor Manta M5P]
sensor_type: temperature_mcu
min_temp: -270
max_temp: 100

[virtual_sdcard]
path: /home/biqu/printer_data/gcodes

#===SAFETY SETTINGS===
[verify_heater extruder]
check_gain_time: 120
heating_gain: 2
hysteresis: 5

[verify_heater heater_bed]
check_gain_time: 120
heating_gain: 1.0
hysteresis: 10

[idle_timeout]
timeout: 9000

[gcode_arcs]
resolution: 0.3

#===CARTOGRAPHER===

[cartographer]                  # uncomment if using cartographer
serial: /dev/serial/by-id/usb-Cartographer_614e_35002C001443565039363120-if00
speed: 400                      #   Z probing dive speed.
lift_speed: 5.                  #   Z probing lift speed.
backlash_comp: 0.5              #   Backlash compensation distance for removing Z backlash before measuring the sensor response.
x_offset: 0.                    #   X offset of cartographer from the nozzle.
y_offset: 16.86                 #   Y offset of cartographer from the nozzle.
trigger_distance: 2.            #   cartographer trigger distance for homing.
trigger_dive_threshold: 1.5     #   Threshold for range vs dive mode probing. Beyond `trigger_distance + trigger_dive_threshold` a dive will be used.
trigger_hysteresis: 0.006       #   Hysteresis on trigger threshold for untriggering, as a percentage of the trigger threshold.
cal_nozzle_z: 0.1               #   Expected nozzle offset after completing manual Z offset calibration.
cal_floor: 0.1                  #   Minimum z bound on sensor response measurement.
cal_ceil:5.                     #   Maximum z bound on sensor response measurement.
cal_speed: 1.0                  #   Speed while measuring response curve.
cal_move_speed: 10.             #   Speed while moving to position for response curve measurement.
default_model_name: default     #   Name of default cartographer model to load.
mesh_main_direction: x          #   Primary travel direction during mesh measurement.
mesh_cluster_size: 1            #   Radius of mesh grid point clusters.
mesh_runs: 2                    #   Number of passes to make during mesh scan.

#===MOTORS===

[stepper_x]
step_pin = PA10
dir_pin = PA14
enable_pin = !PA13
microsteps = 64
rotation_distance = 72
endstop_pin = tmc2209_stepper_x:virtual_endstop
position_endstop = 306.5
position_min = -1
position_max = 306.5
homing_speed = 50
homing_retract_dist = 0

[tmc2209 stepper_x]
uart_pin = PD8
interpolate = False
run_current = 1.2
diag_pin = ^PD2
driver_sgthrs = 72
sense_resistor = 0.100

[stepper_y]
step_pin = PC6
dir_pin = PC7
enable_pin = !PA9
microsteps = 64
rotation_distance = 72
endstop_pin = tmc2209_stepper_y:virtual_endstop
position_endstop = -2
position_min = -2
position_max = 300
homing_speed = 50
homing_retract_dist = 0

[tmc2209 stepper_y]
uart_pin = ^PB10
interpolate = False
run_current = 1.2
diag_pin = ^PC3
driver_sgthrs = 72
sense_resistor = 0.100

[stepper_z] #M1
step_pin: PC8
dir_pin: PC9
enable_pin: !PA15
microsteps: 16
rotation_distance: 8
gear_ratio: 64:20
#endstop_pin: tmc2209_stepper_z:virtual_endstop
endstop_pin: probe:z_virtual_endstop          # uncomment to use cartographer as virtual endstop
homing_retract_dist: 0.0				        # uncomment as cartographer needs this to be set to 0
#position_endstop: 0
position_max: 305
position_min: -20
homing_speed: 6
#custom
#second_homing_speed: 1                          # comment out if using cartographer
#homing_retract_dist: 2.0                        # comment out if using cartographer

[tmc2209 stepper_z] #M1
uart_pin: PD9
run_current: 0.8
diag_pin: PD3
stealthchop_threshold: 0
driver_SGTHRS: 0
sense_resistor: 0.100

[tmc2209 extruder]
uart_pin: nozzle_mcu:PB11
tx_pin: nozzle_mcu:PB10
uart_address: 3
run_current: 0.7
sense_resistor: 0.150
stealthchop_threshold: 0
# driver_IHOLDDELAY: 8
# driver_TPOWERDOWN: 20
# driver_TBL: 2
# driver_TOFF: 3
# driver_HEND: 0
# driver_HSTRT: 5

# ===HEATERS===

[extruder] #CYCLOPSE#
max_extrude_only_distance: 1000.0
max_extrude_cross_section: 80
step_pin: nozzle_mcu:PB1
dir_pin: !nozzle_mcu:PB0
enable_pin: !nozzle_mcu:PB2
microsteps: 32
rotation_distance: 4.637
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: nozzle_mcu:PB7
#############PT1000 HOTEND################
#MAX TEMPERATURE 350
sensor_type: PT1000
sensor_pin: nozzle_mcu:PA0
#   Analog input pin connected to the sensor. This parameter must be
#   provided.
pullup_resistor: 4700
#   The resistance (in ohms) of the pullup attached to the sensor. The
#   default is 4700 ohms.
###################################################
pressure_advance: 0.035
pressure_advance_smooth_time: 0.035
min_extrude_temp: 170
control: pid
pid_Kp: 25.013
pid_Ki: 2.566
pid_Kd: 60.966
min_temp: -270
max_temp: 350

[heater_bed]
heater_pin: PC14
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA0
#control: watermark
#control: pid
#pid_kp: 27
#pid_ki: 0.08
#pid_kd: 0
min_temp: -270
max_temp: 125
#===FAN CONFIGS===

[duplicate_pin_override]
pins: PA4, PA3, PA2, PA1

[multi_pin heater_fans]
pins:nozzle_mcu:PB5,PB2

[heater_fan hotend_fan]
pin: multi_pin:heater_fans
heater: extruder
heater_temp: 50

[temperature_sensor chamber_temp]
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA1
min_temp: -270
max_temp: 65

[static_digital_output my_fan_output_pins]
pins: nozzle_mcu: PB6

[output_pin Nozzle Fan]
#NOZZLE FAN
pin: !nozzle_mcu: PB8
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0.00
scale: 255
shutdown_value: 0.0

# [output_pin Exhaust Fan]
# #EXHAUST FAN
# pin: PA3
# pwm: True
# cycle_time: 0.0100
# hardware_pwm: false
# value: 0.00
# scale: 255
# shutdown_value: 0.0

[output_pin Aux Fan]
# SIDE FAN
pin: PA4
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0.00
scale: 255
shutdown_value: 0.0

[temperature_fan chamber_fan]
pin: PA3
cycle_time: 0.0100
hardware_pwm: false
max_power: 1
shutdown_speed: 0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA1
min_temp: -270
max_temp: 70
control: watermark
max_delta: 2
target_temp: 50
max_speed: 1.0
min_speed: 0.0

[temperature_fan MCU_Fan]   
#MCU FAN          
pin: PA6
tachometer_pin: PC2
cycle_time: 0.01
hardware_pwm: true
max_power: 1
shutdown_speed: 0
sensor_type: temperature_host
min_temp: -270
max_temp: 110
control: pid
pid_Kp: 4.0
pid_Ki: 1
pid_Kd: 0.2
pid_deriv_time: 2.0
target_temp: 40.0
max_speed: 1.0
min_speed: 0.0

# [output_pin LED]
# pin: CB2:gpio79
# pwm: false
# #hardware_pwm: false
# value: 1
# #scale: 255
# shutdown_value: 0.0

# [output_pin power]
# pin: !PC15
#pwm: false
#hardware_pwm: false
#value: 1
#scale: 255
#shutdown_value: 0

[output_pin LED]  
pin: PF8
pwm: true
cycle_time: 0.001
value: 1

#===BED MESH=== 

[bed_mesh]                   # cartographer settings, use this :) 
speed: 400                   # max of 150 or carto will stutter / timeout
mesh_min: 15,22              # x / y offsets for carto.
mesh_max: 270,280            # add a little space from the back of the bed to prevent scanning screws or crashing into the motor mounts
probe_count: 30,30          # tested upto 150x150 points, any higher will timeout the mcu after meshing.
fade_start: 5.0
fade_end: 50.0
algorithm: bicubic
bicubic_tension: 0.1         # required for above 5x5 meshing 

#===PRINTER SETTINGS===
[adxl345]
cs_pin = nozzle_mcu:PA4
spi_speed = 5000000
axes_map = x,-z,y
spi_software_sclk_pin = nozzle_mcu:PA5
spi_software_mosi_pin = nozzle_mcu:PA7
spi_software_miso_pin = nozzle_mcu:PA6

[resonance_tester]
accel_chip: adxl345
accel_per_hz: 75
probe_points:
   150,150,10

[input_shaper]
shaper_freq_x: 48.6 # center frequency for the X axis filter
shaper_type_x: zv # filter type for the X axis
shaper_freq_y: 44.8 # center frequency for the Y axis filter
shaper_type_y: mzv # filter type for the Y axis
damping_ratio_x: 0.091 # damping ratio for the X axis
damping_ratio_y: 0.033 # damping ratio for the Y axis

[display_status]

[filament_motion_sensor Encoder_Sensor]
switch_pin: PC15
detection_length: 4
extruder: extruder
pause_on_runout: true
runout_gcode:
 {% if printer.extruder.can_extrude|lower == 'true' %}
  G91
  G0 E30 F600
  G90
 {% endif %}

[printer]
kinematics: corexy
max_velocity: 800
max_accel: 20000
minimum_cruise_ratio: 0.1
max_z_velocity: 20
square_corner_velocity: 5.0
max_z_accel: 300

[pause_resume]

[axis_twist_compensation]
speed: 300
horizontal_move_z: 5
calibrate_start_x: 20
calibrate_end_x: 200
calibrate_y: 112.5

[firmware_retraction]
retract_length: 0.4
retract_speed: 60
unretract_extra_length: 0
unretract_speed: 60


[include moonraker_obico_macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 43.072
#*# pid_ki = 15.953
#*# pid_kd = 29.074
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 52.637
#*# pid_ki = 3.899
#*# pid_kd = 177.649
#*#
#*# [input_shaper]
#*#
#*# [stepper_z]
#*# position_endstop = 0.705
#*# x_count = 3
#*# y_count = 6
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.1
#*# min_x = 190.9
#*# max_x = 210.9
#*# min_y = 20.94
#*# max_y = 270.94
#*#
#*# [cartographer model default]
#*# model_coef = 1.3888286649759425,
#*# 	1.8114074712388302,
#*# 	0.7159191246722925,
#*# 	0.445680880808646,
#*# 	0.5293686021812223,
#*# 	0.039627761979231825,
#*# 	-0.4454874905314638,
#*# 	0.11788696881147118,
#*# 	0.3620755951257023,
#*# 	0.03985209785165008
#*# model_domain = 3.202995284078049e-07,3.326820665526694e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 42.130376
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.031208, 0.019869, 0.013181, 0.012534, 0.008902, 0.011756, 0.002319, 0.006881, 0.017946, 0.007734, 0.028841, 0.034232, 0.036295, 0.049818, 0.050779, 0.073745
#*# 	  0.003882, -0.001960, -0.002761, -0.002429, -0.007777, -0.009549, -0.006523, -0.007236, -0.002426, -0.010561, 0.012799, 0.006888, 0.007135, 0.037856, 0.044395, 0.059912
#*# 	  -0.010919, -0.011769, -0.021174, -0.017779, -0.030364, -0.030298, -0.023421, -0.037564, -0.021978, -0.022824, -0.012959, -0.004316, -0.003450, 0.004847, 0.006397, 0.030349
#*# 	  -0.016296, -0.024056, -0.023978, -0.023569, -0.031612, -0.030352, -0.032677, -0.027739, -0.016546, -0.020556, -0.009969, -0.014709, -0.001447, 0.006104, 0.017232, 0.050166
#*# 	  0.000404, -0.009644, -0.014185, -0.021004, -0.023978, -0.021156, -0.024290, -0.020481, -0.015193, -0.010302, -0.000265, 0.007072, 0.009652, 0.014404, 0.026559, 0.046547
#*# 	  -0.009156, -0.014480, -0.010236, -0.013522, -0.016062, -0.020432, -0.021675, -0.015076, -0.012093, -0.006968, -0.003701, -0.004142, 0.007001, 0.013087, 0.031856, 0.047809
#*# 	  -0.009946, -0.024428, -0.037549, -0.030593, -0.038930, -0.034289, -0.036911, -0.035648, -0.028709, -0.032965, -0.020580, -0.018863, -0.021301, -0.004715, 0.005442, 0.026071
#*# 	  -0.031192, -0.042894, -0.044597, -0.040685, -0.041799, -0.041802, -0.038596, -0.037383, -0.030957, -0.032731, -0.030585, -0.034386, -0.022130, -0.015504, 0.005703, 0.021872
#*# 	  -0.015329, -0.035389, -0.042798, -0.046579, -0.049674, -0.045060, -0.048182, -0.040778, -0.039095, -0.046291, -0.033951, -0.034908, -0.029152, -0.013712, -0.000620, 0.020963
#*# 	  -0.040383, -0.048479, -0.041067, -0.047736, -0.050266, -0.047609, -0.050955, -0.045326, -0.039084, -0.037561, -0.035386, -0.038231, -0.025351, -0.018184, 0.009249, 0.025661
#*# 	  -0.041356, -0.042997, -0.050385, -0.054179, -0.056342, -0.051552, -0.053845, -0.055062, -0.044667, -0.050406, -0.036791, -0.045624, -0.031422, -0.016382, 0.000087, 0.022030
#*# 	  -0.043840, -0.037530, -0.040751, -0.050826, -0.043295, -0.050832, -0.052869, -0.049236, -0.042915, -0.037275, -0.034623, -0.038814, -0.024153, -0.013333, 0.015953, 0.036234
#*# x_count = 16
#*# y_count = 12
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.1
#*# min_x = 88.0
#*# max_x = 212.0
#*# min_y = 103.0
#*# max_y = 197.0
